using GeolocatorPlugin.Abstractions;
using GeolocatorPlugin;
using Mapsui.UI.Maui;
using DefectMapApplication.Services.API.DefectEndpointService;

namespace DefectMapApplication.ViewModels;

public partial class MainViewModel : BaseViewModel
{
    readonly IDefectEndpoint defectEndpoint;
    
    private MapView mapView = null!;

    private GeolocatorPlugin.Abstractions.Position currentPosition = null!;

    public MainViewModel(IDefectEndpoint defectEndpoint)
    {
        this.defectEndpoint = defectEndpoint;
    }

    public async Task Init(MapView mapView)
    {
        this.mapView = mapView;

        var defects = await defectEndpoint.GetAll();

        foreach (var defect in defects)
        {
            mapView.Pins.Add(new Pin
            {
                Label = defect.Name,
                Position = new Mapsui.UI.Maui.Position(defect.Latitude, defect.Longitude),
                Scale = 0.3f,
                Type = PinType.Svg,
                Svg = "<svg width=\"200\" height=\"235\" viewBox=\"0 0 200 235\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n<path d=\"M40.0258 105.516C38.4192 102.827 40.3872 99.418 43.5194 99.4648L156.375 101.152C159.427 101.198 161.306 104.508 159.779 107.152L104.813 202.357C103.287 205 99.4806 205.029 97.915 202.408L40.0258 105.516Z\" fill=\"#292641\"/>\r\n<circle cx=\"100.5\" cy=\"70.5\" r=\"70.5\" fill=\"#292641\"/>\r\n<g clip-path=\"url(#clip0_4_12)\">\r\n<path d=\"M106.79 31.5464C106.136 32.8507 105.464 34.1876 104.796 35.5274C103.149 38.8318 101.516 42.1421 99.8489 45.4361C99.6454 45.8373 99.3123 46.203 98.9644 46.4961C95.4871 49.4319 91.992 52.3454 88.5132 55.2782C88.3054 55.4529 88.0798 55.7179 88.0415 55.9681C87.5403 59.3317 87.0701 62.7013 86.594 66.0693C86.5807 66.1641 86.5925 66.2603 86.5925 66.472C86.8829 66.472 87.1423 66.472 87.4003 66.472C90.201 66.4735 93.0018 66.4424 95.8025 66.5061C96.3936 66.5194 97.0673 66.7607 97.5478 67.1101C100.033 68.9148 102.467 70.7905 104.921 72.6396C105.937 73.405 106.181 74.5376 105.523 75.4791C104.886 76.3896 103.674 76.5525 102.657 75.7989C100.363 74.1038 98.0976 72.3716 95.804 70.6765C95.549 70.4885 95.1878 70.3508 94.8753 70.3479C91.7547 70.3286 88.6356 70.3375 85.5149 70.3538C85.2319 70.3538 84.8988 70.3789 84.6762 70.5255C82.0111 72.2858 79.3621 74.0727 76.7103 75.8537C76.6351 75.904 76.5761 75.9766 76.4449 76.1009C77.5711 76.6709 78.6413 77.2128 79.7115 77.7516C82.7614 79.2854 85.8142 80.8147 88.8626 82.3544C90.0492 82.954 90.4737 84.0495 89.9519 85.0962C89.4404 86.1207 88.2891 86.4212 87.0996 85.8246C82.7953 83.6661 78.4954 81.5031 74.1925 79.3417C74.0407 79.2647 73.883 79.1966 73.6368 79.0811C73.2241 80.3099 72.8172 81.5105 72.4178 82.7127C71.7574 84.698 71.1058 86.6862 70.441 88.6701C70.102 89.6812 69.4696 90.1091 68.3021 90.112C65.5751 90.1194 62.8481 90.0943 60.121 90.1342C59.6405 90.1416 59.0995 90.2956 58.6941 90.5547C56.9989 91.6354 55.3465 92.7813 53.5083 94.0175C53.8916 94.056 54.0876 94.0915 54.2851 94.0915C73.6693 94.0915 93.0534 94.09 112.437 94.0885C118.677 94.0885 124.917 94.0826 131.157 94.0989C134.224 94.1078 137.29 94.1892 140.358 94.1877C143.72 94.1877 147.081 94.1167 150.444 94.1063C150.988 94.1048 151.17 93.9553 151.157 93.3957C151.122 91.9167 151.188 90.4333 151.125 88.9558C151.1 88.3843 150.875 87.8099 150.675 87.2621C149.957 85.2961 149.183 83.3493 148.495 81.3729C148.309 80.8399 148.232 80.2092 148.316 79.6555C148.429 78.9123 149.158 78.409 149.914 78.3438C150.806 78.2668 151.552 78.6133 151.85 79.3846C152.899 82.0953 153.912 84.8209 154.92 87.5464C155.01 87.7907 154.994 88.0823 154.994 88.3518C154.998 90.8197 155 93.2861 154.996 95.7541C154.993 97.2997 154.292 97.9955 152.734 97.997C141.213 97.9984 129.69 97.997 118.169 97.997C101.463 97.997 84.7573 97.997 68.0515 97.997C61.0998 97.997 54.1481 97.9999 47.1963 97.994C45.5173 97.994 44.515 96.5654 45.2358 95.1752C45.4171 94.8258 45.7591 94.5208 46.0922 94.2958C49.8408 91.7657 53.5909 89.2386 57.3719 86.7573C57.8539 86.442 58.5025 86.2525 59.0803 86.2377C61.3637 86.1799 63.65 86.214 65.9348 86.214C66.1927 86.214 66.4507 86.214 66.8575 86.214C66.2193 85.0977 65.6635 84.1206 65.1034 83.1464C61.8781 77.5311 58.6514 71.9171 55.4276 66.3018C54.6227 64.8997 53.7943 63.5081 53.0528 62.0721C52.8494 61.6783 52.9275 61.1394 52.8907 60.7959C53.2503 60.6716 53.4847 60.6553 53.6218 60.5309C54.3279 59.8884 55.087 59.3969 56.0747 59.308C56.2634 59.2903 56.4167 58.9971 56.6068 58.858C57.9246 57.8942 58.9034 56.5203 60.435 55.8023C61.5907 55.2605 62.369 55.2723 63.193 56.2539C63.8357 57.0193 64.3885 57.8735 64.8941 58.7395C65.7977 60.2852 66.5981 61.8915 67.5135 63.4297C68.0221 64.2854 68.8726 64.5208 69.7423 64.0662C71.0262 63.3956 72.2836 62.6657 73.5042 61.8855C74.4078 61.3082 74.6097 60.26 74.0555 59.2725C72.8511 57.1244 71.6188 54.9925 70.3835 52.8621C69.5463 51.4201 69.7806 50.4001 71.1899 49.5799C73.2904 48.3571 75.3954 47.1401 77.5048 45.9306C78.6811 45.2555 79.7572 45.5546 80.4382 46.7345C81.644 48.8249 82.8439 50.9183 84.0468 53.0102C84.1691 53.2219 84.2973 53.4291 84.4064 53.6142C88.1624 50.4697 91.9051 47.3592 95.6109 44.2073C96.1519 43.7469 96.6324 43.1414 96.9538 42.5078C99.358 37.7629 101.712 32.9943 104.087 28.2346C104.671 27.0636 105.642 26.7112 106.852 27.2309C111.32 29.1466 115.784 31.0756 120.254 32.9839C121.03 33.3156 121.453 33.8752 121.612 34.688C122.159 37.4683 122.703 40.2486 123.287 43.02C123.365 43.3946 123.59 43.8017 123.87 44.0578C125.014 45.1015 126.217 46.0786 127.374 47.1076C128.284 47.9174 128.414 49.1151 127.73 49.9382C127.006 50.8102 125.821 50.8665 124.84 50.0655C124.46 49.7546 124.094 49.4245 123.72 49.1047C123.161 48.625 122.6 48.1454 121.947 47.5857C121.462 48.2223 120.989 48.8338 120.526 49.4526C119.492 50.8324 118.449 52.2033 117.442 53.6023C116.93 54.313 116.266 54.5854 115.421 54.5794C113.483 54.5661 111.544 54.6002 109.607 54.5646C109.052 54.5543 108.708 54.7275 108.382 55.1716C106.823 57.2946 105.241 59.3998 103.649 61.4991C102.849 62.5547 101.755 62.7679 100.831 62.0884C99.8828 61.3925 99.7693 60.2467 100.579 59.1541C102.439 56.6403 104.326 54.1472 106.179 51.6274C106.68 50.9464 107.314 50.6621 108.135 50.6681C110.125 50.6814 112.115 50.6592 114.105 50.6873C114.575 50.6932 114.876 50.5467 115.15 50.1706C116.501 48.323 117.89 46.5006 119.226 44.6411C119.411 44.382 119.492 43.9438 119.433 43.6255C119.009 41.3486 118.546 39.0775 118.061 36.8124C118.004 36.5459 117.787 36.2025 117.555 36.1003C114.05 34.5606 110.529 33.055 107.01 31.5449C106.97 31.5272 106.916 31.5435 106.786 31.5435L106.79 31.5464ZM74.4859 52.1752C75.4912 53.9221 76.4759 55.5684 77.3957 57.2502C78.6634 59.5656 78.5927 61.9107 76.9697 63.9671C76.1428 65.0137 74.8972 65.7466 73.7739 66.5253C73.1975 66.925 72.4472 67.0583 71.8252 67.4032C69.0097 68.9607 66.1397 67.9465 64.328 65.5867C63.3227 64.278 62.6196 62.7324 61.8015 61.283C61.4551 60.6686 61.1897 59.9846 60.2655 60.448C60.1726 60.4939 59.9957 60.3903 59.8645 60.3399C59.1157 60.0468 58.7133 60.5738 58.2519 61.0002C57.8067 61.4103 57.8421 61.89 58.0514 62.3548C58.6248 63.6295 59.1658 64.9279 59.8468 66.1433C62.0255 70.0281 64.2617 73.8802 66.4787 77.7428C67.1848 78.9745 67.9027 80.1988 68.6987 81.5727C69.3532 79.6185 69.9045 77.8123 70.5752 76.0521C70.7948 75.4732 71.2341 74.8958 71.7264 74.5213C72.8968 73.63 74.194 72.9105 75.3733 72.0297C77.3368 70.5655 79.2029 68.9666 81.1988 67.5498C82.3295 66.7474 82.8218 65.7643 82.9279 64.4304C83.0326 63.1321 83.2964 61.847 83.4527 60.5502C83.491 60.2304 83.4763 59.8381 83.3259 59.5701C82.2336 57.6144 81.103 55.6824 79.9827 53.743C79.3091 52.5779 78.6339 51.4127 77.9279 50.1928C76.7722 50.859 75.6725 51.4927 74.4874 52.1752H74.4859Z\" fill=\"white\"/>\r\n<path d=\"M139.854 55.9283C141.254 54.9542 142.494 53.9282 143.884 53.188C144.704 52.7512 145.757 52.652 146.716 52.6091C147.877 52.5573 148.679 53.4737 148.647 54.5722C148.613 55.7047 147.815 56.4509 146.629 56.4568C145.657 56.4627 144.6 57.0076 143.903 57.8825C145.808 58.3651 147.47 59.2416 148.883 60.6214C151.608 63.2832 152.571 67.9112 151.082 71.445C150.508 72.8041 149.163 73.2601 148.016 72.3511C144.205 69.3339 137.818 71.2526 136.667 76.6681C136.009 79.7623 135.75 82.8594 136.55 85.9669C136.648 86.3429 136.81 86.7115 136.999 87.0506C137.69 88.2897 137.268 89.5777 135.911 90.0278C133.269 90.9013 129.201 90.5815 126.773 87.4562C125.635 85.992 124.293 85.1437 122.435 84.8728C118.909 84.3591 116.818 82.0807 115.661 78.831C115.524 78.4476 115.486 78.0109 115.486 77.5978C115.486 76.6888 116.143 75.8494 117.041 75.8316C119.447 75.7828 121.454 74.6991 123.35 73.417C124.724 72.4873 126.073 71.4435 127.197 70.231C130.496 66.675 129.229 60.879 124.809 58.9025C123.382 58.2645 123.045 56.8669 124.019 55.6396C127.908 50.7393 135.387 50.6342 139.428 55.422C139.599 55.6248 139.77 55.8291 139.855 55.9298L139.854 55.9283ZM141.169 67.0717C138.481 65.2315 135.591 63.5216 132.423 62.0278C132.525 62.4882 132.601 62.7947 132.659 63.1041C133.344 66.7934 132.628 70.1333 130.051 72.9255C127.528 75.6599 124.475 77.6452 121.011 78.9909C120.772 79.0842 120.535 79.1804 120.265 79.2885C121.04 80.578 122.274 80.8504 123.527 81.1717C124.7 81.4707 125.927 81.7698 126.956 82.3693C127.921 82.9319 128.698 83.8513 129.487 84.6818C130.34 85.582 131.173 86.4495 132.556 86.4125C132.564 86.2896 132.585 86.2141 132.572 86.1475C131.944 82.8786 132.115 79.6261 132.752 76.3794C133.307 73.5428 134.547 71.0808 136.94 69.4049C138.244 68.4915 139.736 67.8505 141.167 67.0732L141.169 67.0717ZM147.861 67.1694C147.802 66.7386 147.789 66.4958 147.734 66.2619C147.156 63.7747 145.104 61.9612 142.432 61.6059C140.07 61.2905 138.221 60.1402 136.707 58.3118C136.124 57.6071 135.402 56.9498 134.613 56.5027C132.952 55.5611 131.191 55.5478 129.243 56.3754C136.023 59.0728 142.121 62.5948 147.861 67.1709V67.1694Z\" fill=\"white\"/>\r\n<path d=\"M96.0502 76.2743C96.062 77.3995 95.2085 78.2877 94.1251 78.2789C93.0504 78.27 92.2117 77.435 92.1896 76.3543C92.169 75.275 92.993 74.3897 94.044 74.3645C95.1672 74.3379 96.0369 75.1654 96.0487 76.2728L96.0502 76.2743Z\" fill=\"white\"/>\r\n<path d=\"M141.315 86.1505C141.325 85.086 142.184 84.2422 143.25 84.2466C144.347 84.251 145.206 85.0831 145.205 86.1372C145.205 87.2815 144.35 88.1224 143.184 88.1239C142.15 88.1239 141.303 87.2312 141.313 86.1505H141.315Z\" fill=\"white\"/>\r\n<path d=\"M109.828 40.8084C110.941 40.8128 111.798 41.673 111.787 42.7774C111.777 43.8492 110.934 44.6931 109.862 44.7005C108.743 44.7094 107.914 43.8714 107.915 42.7359C107.917 41.6552 108.761 40.8039 109.827 40.8084H109.828Z\" fill=\"white\"/>\r\n<path d=\"M92.191 60.4748C92.219 59.3334 93.043 58.5665 94.2046 58.5976C95.3072 58.6272 96.0973 59.5096 96.0487 60.654C96.003 61.7154 95.1244 62.5031 94.0277 62.466C92.9575 62.429 92.163 61.5689 92.191 60.4748Z\" fill=\"white\"/>\r\n<path d=\"M101.967 86.1519C100.856 86.1385 100.013 85.2754 100.042 84.1799C100.07 83.1036 100.921 82.2479 101.957 82.2538C103.095 82.2597 103.917 83.1051 103.929 84.2791C103.938 85.2902 103.024 86.1652 101.969 86.1519H101.967Z\" fill=\"white\"/>\r\n<path d=\"M80.338 88.1684C80.3572 89.2387 79.4683 90.1226 78.3731 90.1226C77.412 90.1226 76.5069 89.2239 76.476 88.2379C76.4421 87.1868 77.2852 86.2497 78.2935 86.2156C79.4167 86.1786 80.3189 87.0402 80.3395 88.1684H80.338Z\" fill=\"white\"/>\r\n<path d=\"M119.616 62.5148C119.609 63.6089 118.794 64.4394 117.724 64.4409C116.617 64.4424 115.76 63.5778 115.776 62.4764C115.794 61.3482 116.606 60.5651 117.762 60.5636C118.831 60.5621 119.622 61.3956 119.615 62.5148H119.616Z\" fill=\"white\"/>\r\n</g>\r\n<defs>\r\n<clipPath id=\"clip0_4_12\">\r\n<rect width=\"110\" height=\"71\" fill=\"white\" transform=\"translate(45 27)\"/>\r\n</clipPath>\r\n</defs>\r\n</svg>\r\n"
            });
        }

        if (await CrossGeolocator.Current.StartListeningAsync(
                    TimeSpan.FromSeconds(0.5f),
                    1,
                    true,
                    new ListenerSettings
                    {
                        ActivityType = ActivityType.AutomotiveNavigation,
                        AllowBackgroundUpdates = true,
                        DeferLocationUpdates = false,
                        ListenForSignificantChanges = false,
                        PauseLocationUpdatesAutomatically = false,
                        ShowsBackgroundLocationIndicator = true,
                    }
                )
            )
        {
            CrossGeolocator.Current.PositionChanged += Current_PositionChanged;
        }
    }

    private async void Current_PositionChanged(object sender, PositionEventArgs e)
    {
        Mapsui.UI.Maui.Position mauiPosition = new Mapsui.UI.Maui.Position(e.Position.Latitude, e.Position.Longitude);
        mapView.MyLocationLayer.UpdateMyLocation(mauiPosition);

        if(currentPosition is null)
        {
            mapView.MyLocationFollow = true;
        }

        if(mapView.MyLocationFollow)
        {
            mapView.Map.Navigator.CenterOnAndZoomTo(mauiPosition.ToMapsui(), 1);
        }

        currentPosition = e.Position;
    }
}
